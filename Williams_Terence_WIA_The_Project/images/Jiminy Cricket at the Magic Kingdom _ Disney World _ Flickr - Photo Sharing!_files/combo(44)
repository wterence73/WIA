YUI.add("search-photos-route",function(e){function t(e){t.superclass.constructor.call(this,e)}e.Routes[this.name]=t,e.extend(t,e.FlickrRoute,{langBundles:this.details.langBundles,run:function(t){var n={},r=this,i,s=!0,o=!0,u,a,f,l={};n.apiParams=this.processRequest(t),n.viewerNsid=t.probableUser||this.appContext.getViewer().nsid,i=n.apiParams[e.SearchHelper.API.text]||n.apiParams[e.SearchHelper.API.tags],!i&&!this.appContext.flipper.isFlipped("enable-slender-advanced-search")&&(s=!1),n.apiParams[e.SearchHelper.UNIFIED_STATE_PARAMS.albums]&&n.apiParams[e.SearchHelper.UNIFIED_STATE_PARAMS.viewAll]&&(o=!1,s=!1);switch(n.apiParams[e.SearchHelper.UNIFIED_STATE_PARAMS.viewType]){case"thumbs":u=e.Models["person-preferences-models"].UNIFIED_SEARCH_VIEW_TYPES.thumbs;break;case"tiles":u=e.Models["person-preferences-models"].UNIFIED_SEARCH_VIEW_TYPES.tiles;break;case"justified":u=e.Models["person-preferences-models"].UNIFIED_SEARCH_VIEW_TYPES.justified}return f=this.generateUnifiedSubviewParams(n),f.everyone&&(l.everyone=this.appContext.getModel("search-photos-lite-models",f.everyone.id,f.everyone.fetchParams)),f.yours&&(l.yours=this.appContext.getModel("search-photos-lite-models",f.yours.id,f.yours.fetchParams)),f.contacts&&(l.contacts=this.appContext.getModel("search-photos-lite-models",f.contacts.id,f.contacts.fetchParams)),f.albums&&(l.albums=this.appContext.getModel("search-sets-models",f.albums.id,f.albums.fetchParams)),!u&&n.viewerNsid&&(l.viewerPrefs=this.appContext.getModel("person-preferences-models",n.viewerNsid)),a=t.query&&parseFloat(t.query.row_height)||1,a=Math.max(.5,Math.min(4,a)),e.FlickrPromise(l).then(function(t){u||(t.viewerPrefs?u=t.viewerPrefs.getValue("unifiedSearchViewPref"):u=e.Models["person-preferences-models"].UNIFIED_SEARCH_VIEW_TYPE_DEFAULT),r.appContext.flipper.isFlipped("search-tiles")||u===e.Models["person-preferences-models"].UNIFIED_SEARCH_VIEW_TYPES.tiles&&(u=e.Models["person-preferences-models"].UNIFIED_SEARCH_VIEW_TYPE_DEFAULT);var i=n.apiParams[e.SearchHelper.API.text]||n.apiParams[e.SearchHelper.API.tags],l=r.intlMessage({intlName:"search.SEARCH"});return i!==undefined&&(l+=": "+i),e.Promise.resolve({view:"search-photos-unified-page-view",params:{unifiedSubviewParams:f,searchType:e.SearchUrl.searchTypes.PHOTOS,searchTerm:i,modelParams:n,showTools:s,showAdvanced:o,showSort:s,viewType:u,rowHeightMod:a},layout:"scrolling",fluid:!0,title:l})},function(t){e.Flog.warn("search-photos-route",t.message);var i=n.apiParams[e.SearchHelper.API.text]||n.apiParams[e.SearchHelper.API.tags],s=r.intlMessage({intlName:"search.SEARCH"});return i!==undefined&&(s+=": "+i),e.Promise.resolve({view:"search-photos-unified-page-view",params:{searchTerm:i,apiFailed:!0,modelParams:n},fluid:!0,title:s})})},generateUnifiedSubviewParams:function(t){var n={},r=t.apiParams,i;return e.SearchHelper.isParameterlessSearch(r)?n:(this.shouldPerformEveryoneSearch(t,r)&&(i=new e.SearchUrl(r,this.appContext,e.SearchUrl.searchTypes.PHOTOS),n.everyone={id:i.getId(),fetchParams:{apiParams:i.getAPIParams(),perPage:25}}),this.shouldPerformYoursSearch(t,r)&&(i=new e.SearchUrl(e.merge({user_id:t.viewerNsid,sort:e.SearchHelper.API_SORT_OPTIONS.dateTaken},r),this.appContext,e.SearchUrl.searchTypes.PHOTOS),n.yours={id:i.getId(),fetchParams:{apiParams:i.getAPIParams(),perPage:20}}),this.shouldPerformContactsSearch(t,r)&&(i=new e.SearchUrl(e.merge(r,{contacts:"all"}),this.appContext,e.SearchUrl.searchTypes.PHOTOS),n.contacts={id:i.getId(),fetchParams:{apiParams:i.getAPIParams(),perPage:20}}),this.shouldPerformAlbumsSearch(t,r)&&(i=new e.SearchUrl(e.merge(r,{user_id:t.viewerNsid}),this.appContext,e.SearchUrl.searchTypes.PHOTOS),n.albums={id:i.getId(),fetchParams:{apiParams:i.getAPIParams(),perPage:20}}),n)},shouldPerformEveryoneSearch:function(t,n){return!n[e.SearchHelper.UNIFIED_STATE_PARAMS.albums]||!n[e.SearchHelper.UNIFIED_STATE_PARAMS.viewAll]},shouldPerformYoursSearch:function(t,n){return t.viewerNsid&&!n[e.SearchHelper.API.userId]&&!n[e.SearchHelper.API.groupId]&&!n[e.SearchHelper.API.contacts]&&!n[e.SearchHelper.API.faves]&&!n[e.SearchHelper.UNIFIED_STATE_PARAMS.viewAll]},shouldPerformContactsSearch:function(t,n){return t.viewerNsid&&!n[e.SearchHelper.API.userId]&&!n[e.SearchHelper.API.groupId]&&!n[e.SearchHelper.API.contacts]&&!n[e.SearchHelper.API.faves]&&!n[e.SearchHelper.UNIFIED_STATE_PARAMS.viewAll]},shouldPerformAlbumsSearch:function(t,n){return!t.viewerNsid||!n[e.SearchHelper.API.text]?!1:parseInt(n[e.SearchHelper.API.marketplace])?!1:n[e.SearchHelper.UNIFIED_STATE_PARAMS.albums]?!0:!n[e.SearchHelper.API.userId]&&!n[e.SearchHelper.API.groupId]&&!n[e.SearchHelper.API.contacts]&&!n[e.SearchHelper.API.faves]&&!n[e.SearchHelper.UNIFIED_STATE_PARAMS.viewAll]},processRequest:function(t){var n={};return n=e.merge(t.query,e.SearchHelper.mapRouteParamsToAPI(t.params)),n=e.SearchHelper.mapClassicSearchToAPI(n,this.appContext),e.SearchHelper.addParamDefaults(n),YUI.Env.isServer&&e.SearchHelper.unescapeParameters(n),n}}),e.mix(t.prototype,e.Localizable)},"@VERSION@",{requires:["flog","flickr-route","flickr-promise","search-helper","localizable","search-photos-lite-models","search-sets-models","url","search-url","search-photos-unified-page-view","person-preferences-models"],langBundles:["search"]});
